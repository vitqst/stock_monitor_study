<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test</title>
    <script src="js/gridstack-h5.js"></script>
    <link href="css/gridstack.min.css" rel="stylesheet"/>
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script
            src="https://code.jquery.com/jquery-3.6.0.min.js"
            integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
            crossorigin="anonymous"></script>
    <script src="js/vue.js"></script>

    <link rel="stylesheet" href="/css/main.css">
</head>
<body>

<div class="container">
    <div class="grid-stack full-wh">
    </div>
</div>
<script>
    $(document).ready(() => {
        const $common = {
            "autosize": true,
            "symbol": "BINANCE:RVNUSDT",
            "interval": "D",
            "timezone": "Etc/UTC",
            "theme": "Dark",
            "style": "1",
            "locale": "en",
            "toolbar_bg": "rgba(0, 0, 0, 1)",
            "enable_publishing": false,
            "hide_top_toolbar": false,
            "allow_symbol_change": true,
            "save_image": false,
            "hideideas": false,
            "studies": [
                'LinearRegression@tv-basicstudies',
                'RSI@tv-basicstudies',
                'MASimple@tv-basicstudies',
            ]
        }

        const WIDGET_TYPE = {
            NORMAL: 0,
            Technical_Analysis: 1,
            Custom: 2
        }

        const widgets = [
            {
                w: 12, h: 1,
                config: {
                    content: `<div id="vue-app">
    <div class="vue-app-container">
        <div class="total">TOTAL: {{ roundNum(total) }} USDT</div>
        <div class="total-realtime">REALTIME TOTAL: {{ roundNum(totalNew) }} USDT</div>
        <div class="total-realtime">PROFIT: {{ profit.money }} USDT /{{ profit.percent }} %</div>
    </div>
</div>`
                },
                type: WIDGET_TYPE.Custom
            },
            // Big - 1
            {
                w: 5, h: 3,
                config: {...$common, "symbol": "BINANCE:RVNUSDT"},
                type: WIDGET_TYPE.NORMAL
            },
            // Big - 2
            {
                w: 4, h: 3,
                config: {...$common, "symbol": "BINANCE:RVNUSDT", "interval": "60"},
                type: WIDGET_TYPE.NORMAL
            },
            // Small - 1
            {
                w: 3, h: 3,
                config: {
                    "interval": "1h",
                    "width": '100%',
                    "isTransparent": false,
                    "height": '100%',
                    "symbol": "BINANCE:RVNUSDT",
                    "showIntervalTabs": true,
                    "locale": "en",
                    "colorTheme": "dark"
                },
                type: WIDGET_TYPE.Technical_Analysis
            },
            // Big - 3
            {
                w: 5, h: 3,
                config: {...$common, "symbol": "BINANCE:ALGOUSDT", "interval": "60"},
                type: WIDGET_TYPE.NORMAL
            },
            // Big - 4
            {
                w: 4, h: 3,
                config: {...$common, "symbol": "BINANCE:ALGOUSDT"},
                type: WIDGET_TYPE.NORMAL
            },
            // Small - 2
            {
                w: 3, h: 3,
                config: {
                    "interval": "1h",
                    "width": '100%',
                    "isTransparent": false,
                    "height": '100%',
                    "symbol": "BINANCE:ALGOUSDT",
                    "showIntervalTabs": true,
                    "locale": "en",
                    "colorTheme": "dark"
                },
                type: WIDGET_TYPE.Technical_Analysis
            },

            {
                w: 3, h: 3,
                config: {...$common, "symbol": "BINANCE:ALGOUSDT"},
                type: WIDGET_TYPE.NORMAL
            },
            {
                w: 3, h: 3,
                config: {...$common, "symbol": "BINANCE:ALGOUSDT"},
                type: WIDGET_TYPE.NORMAL
            },
        ]

        const grid = GridStack.init();
        grid.load(widgets.map((item, k) => {
            return {
                w: item.w,
                h: item.h,
                content: `<div class="full-wh" style="background: aliceblue"><div id="widget-${k}" class="full-wh"></div></div>`,
            }
        }));

        widgets.map((item, k) => {
            const widgetId = `widget-${k}`

            if (item.type === WIDGET_TYPE.NORMAL) {
                if (document.getElementById(widgetId)) {
                    // debugger
                    document.getElementById(widgetId).value = new TradingView.widget({
                        ...item.config,
                        "container_id": widgetId
                    })
                }
            }

            if (item.type === WIDGET_TYPE.Technical_Analysis) {
                const script = document.createElement('script')
                script.src = 'https://s3.tradingview.com/external-embedding/embed-widget-technical-analysis.js'
                script.async = true
                script.innerHTML = JSON.stringify(item.config)
                document.getElementById(widgetId).appendChild(script)
            }

            if (item.type === WIDGET_TYPE.Custom) {
                console.log(item.config.content)
                document.getElementById(widgetId).innerHTML = item.config.content

                new Vue({
                    el: `#${widgetId}`,
                    data: {
                        soDienSd: 'hix',
                        total: 0,
                        walletGroupByCoin: [], // [{name: "", volume: 123,123}]
                        priceRealTime: {
                            RVN: 0,
                            ALGO: 0
                        },
                        wallet: [
                            {
                                name: 'RVN',
                                volume: 300,
                                price: 0.16326
                            },
                            {
                                name: 'RVN',
                                volume: 2428,
                                price: 0.17216
                            },
                            {
                                name: 'RVN',
                                volume: 1273,
                                price: 0.16453
                            },
                            {
                                name: 'ALGO',
                                volume: 50,
                                price: 1.0955
                            },
                            {
                                name: 'ALGO',
                                volume: 97.72,
                                price: 1.0577
                            },
                        ]
                    },
                    computed: {
                        totalNew() {
                            let tempTotalNew = 0
                            for (const item of this.walletGroupByCoin) {
                                tempTotalNew = item.volume * this.priceRealTime[item.name] + tempTotalNew
                            }

                            return tempTotalNew
                        },
                        profit() {
                            const s = this.totalNew - this.total
                            return {
                                money: this.roundNum(s),
                                percent: this.roundNum(s/this.total * 100),
                            }
                        }
                    },
                    mounted() {
                        for (const item of this.wallet) {
                            this.total = item.price * item.volume + this.total
                        }

                        for (const item of this.wallet) {
                            const index = this.walletGroupByCoin.findIndex(itemWallet => itemWallet.name === item.name)
                            if (index !== -1) {
                                this.walletGroupByCoin[index] = {
                                    name: this.walletGroupByCoin[index].name,
                                    volume: this.walletGroupByCoin[index].volume + item.volume
                                }
                            } else {
                                this.walletGroupByCoin.push({
                                    name: item.name,
                                    volume: item.volume
                                })
                            }
                        }

                        this.getCoinList()
                    },
                    methods: {
                        getCoinList: function () {
                            // this is where you paste your api key
                            const apiKey = "2131626c800f620f4d84eebe376cd298a4709ce80230600d53b8ae06309323c1";
                            const ccStreamer = new WebSocket('wss://streamer.cryptocompare.com/v2?api_key=' + apiKey);
                            ccStreamer.onopen = function onStreamOpen() {
                                const subRequest = {
                                    "action": "SubAdd",
                                    "subs": ["2~Binance~RVN~USDT", "2~Binance~ALGO~USDT"]
                                };
                                ccStreamer.send(JSON.stringify(subRequest));
                            }

                            ccStreamer.onmessage = (message) => {
                                const data = JSON.parse(message.data)
                                // FLAGS: 2
                                // FROMSYMBOL: "ALGO"
                                // LASTTRADEID: "16013507"
                                // LASTUPDATE: 1614765592
                                // LASTVOLUME: 14.16
                                // LASTVOLUMETO: 16.214616
                                // MARKET: "Binance"
                                // PRICE: 1.1451
                                // TOSYMBOL: "USDT"
                                // TYPE: "2"
                                // VOLUME24HOUR: 79662923.7
                                // VOLUME24HOURTO: 88486140.375477
                                // VOLUMEDAY: 31079802.16
                                // VOLUMEDAYTO: 34884722.128181
                                // VOLUMEHOUR: 3423258.23
                                // VOLUMEHOURTO: 3927222.191424
                                if (data.TYPE === "2" && data.PRICE) {
                                    this.priceRealTime[data.FROMSYMBOL] = data.PRICE
                                }
                            }
                        },
                        roundNum: (number, digit = 2) => {
                            let round = 1
                            for (let i = 0; i < digit; i++) {
                                round = round * 10
                            }

                            return Math.round(number * round) / round
                        }
                    }
                })

            }
        })

        // getCoinList()
        // setInterval(calculateProfit, 1000)
    })
</script>
</body>
</html>